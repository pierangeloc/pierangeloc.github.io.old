
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Pierangelo Cecchetto</title>
  <meta name="author" content="Pierangelo Cecchetto">

  
  <meta name="description" content="Any application in an enterprise context, regardless how small this context might be, must relate with other systems. These systems might be File &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pierangeloc.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Pierangelo Cecchetto" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=EB+Garamond:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=EB+Garamond:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  


  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-60511380-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>




</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Pierangelo Cecchetto</a></h1>
  
    <h2>yet another blog about software (and baking)</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pierangeloc.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/22/ride-the-camel-1/">Getting Started With Apache Camel</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-22T21:11:55+02:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-07-22T21:11:55+02:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2015</span></span></time></time>
        
         | <a href="/blog/2015/07/22/ride-the-camel-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Any application in an enterprise context, regardless how small this context might be, must relate with other systems. These systems might be File system, databases, webservices, message queues, logging systems, or systems using a particular communication protocol. Moreover, data typically undergo transformations, switching and routing logics before reaching other systems. The variety of combinations this allows is enormous, and tackling each of these in a hand made, custom way might easily become an integration nightmare. <em>Enterprise Integration Patterns</em> (EIP) establish a standard way to describe and identify the different approaches that one can follow to deal with an integration problem (see <a href="http://www.enterpriseintegrationpatterns.com">http://www.enterpriseintegrationpatterns.com</a>). They establish a common vocabulary that can be used unambiguously when talking about integration. If we consider that integration solutions are ubuquitous in application development, we realize easily how convenient it might be to have solid foundations on this subject.</p>

<p><a href="http://camel.apache.org/">Apache Camel</a> is a framework that implements EIPs through a very expressive DSL, so one can translate almost immediately any EIP to a corresponding expression in the DSL. Moreover, Camel provides an extensible set of components that allows you to deal with basically any system that might come at hand. A key feature of Camel is that it deals with a <em>normalized message format</em>, so after the consumption point the message has a standard format, e.g. it can be handled identically either if it comes from consuming from a JMS queue or from a SOAP or REST webservice. </p>

<p>It is easier to grasp the concepts setting up a simple Camel project and seeing these features at work.</p>

<p>Camel is a Spring-based framework, so the easiest way to use it is to include it in your Spring context. We will use Camel 2.15.1 that provides a way to setup a Camel-based application without the need of xml configuration.</p>

<h4 id="maven-dependencies">Maven Dependencies</h4>
<p>First of all letâ€™s include the dependencies in our <code>pom.xml</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="XML"><span class="line"><span class="nt">&lt;dependencies&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nt">&lt;dependency&gt;</span>
</span><span class="line">        <span class="nt">&lt;groupId&gt;</span>junit<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">        <span class="nt">&lt;artifactId&gt;</span>junit<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">        <span class="nt">&lt;version&gt;</span>3.8.1<span class="nt">&lt;/version&gt;</span>
</span><span class="line">        <span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dependency&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="c">&lt;!-- camel --&gt;</span>
</span><span class="line">    <span class="nt">&lt;dependency&gt;</span>
</span><span class="line">        <span class="nt">&lt;groupId&gt;</span>org.apache.camel<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">        <span class="nt">&lt;artifactId&gt;</span>camel-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">        <span class="nt">&lt;version&gt;</span>${camel.version}<span class="nt">&lt;/version&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dependency&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nt">&lt;dependency&gt;</span>
</span><span class="line">        <span class="nt">&lt;groupId&gt;</span>org.apache.camel<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">        <span class="nt">&lt;artifactId&gt;</span>camel-spring<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">        <span class="nt">&lt;version&gt;</span>${camel.version}<span class="nt">&lt;/version&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dependency&gt;</span>
</span><span class="line">
</span><span class="line">    <span class="nt">&lt;dependency&gt;</span>
</span><span class="line">        <span class="nt">&lt;groupId&gt;</span>org.apache.camel<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">        <span class="nt">&lt;artifactId&gt;</span>camel-spring-javaconfig<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">        <span class="nt">&lt;version&gt;</span>${camel.version}<span class="nt">&lt;/version&gt;</span>
</span><span class="line">    <span class="nt">&lt;/dependency&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependencies&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>camel-core</code> provides the essence of the camel infrastructure and basic components, <code>camel-spring</code> and <code>camel-spring-javaconfig</code> provide the classes and annotations that allow us to configure and run Camel within a Java-configured Spring application.</p>

<h4 id="embed-camel-in-a-bootable-application">Embed Camel in a bootable application</h4>
<p>The <code>org.apache.camel.spring.javaconfig.CamelConfiguration</code> abstract class can be used as a base Spring configuration class, where we can reference all the beans we might need in the standard Spring way (xml or annotations based). The additional thing that this class does is loading a <code>CamelContext</code> and injecting any bean that extends <code>RouteBuilder</code> available in the Spring context, in the <code>CamelContext</code>. More about the <code>CamelContext</code> will follow along the article.
To give ourselves some more flexibility we will also use a standard xml Spring configuration file.</p>

<p>The simplest configuration of such an application boils down to:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * We extend CamelConfiguration so we can build a Camel Context using purely annotated classes</span>
</span><span class="line"><span class="cm"> *</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="nd">@Configuration</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Boot</span> <span class="kd">extends</span> <span class="n">CamelConfiguration</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span> <span class="n">String</span><span class="o">[]</span> <span class="n">args</span> <span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Main</span> <span class="n">main</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Main</span><span class="o">();</span>
</span><span class="line">        <span class="c1">//use any route builder and components declared within this package</span>
</span><span class="line">        <span class="n">main</span><span class="o">.</span><span class="na">setFileApplicationContextUri</span><span class="o">(</span><span class="s">&quot;classpath:/spring/spring.xml&quot;</span><span class="o">);</span>
</span><span class="line">        <span class="n">main</span><span class="o">.</span><span class="na">setBasedPackages</span><span class="o">(</span><span class="s">&quot;nl.sytac.edu&quot;</span><span class="o">);</span>
</span><span class="line">        <span class="n">main</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Bean</span>
</span><span class="line">    <span class="kd">public</span> <span class="n">RouteBuilder</span> <span class="nf">getSimpleRouteBuilder</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="k">new</span> <span class="nf">SimpleRouteBuilder</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h6 id="integrating-camel-in-an-existing-web-application">Integrating Camel in an existing (web) application</h6>
<p>If you want to integrate Camel in an existing application, injecting a <code>CamelContext</code> in an existing Spring application context is pretty straightforward, see e.g. <a href="https://github.com/pierangeloc/webshop-camel-springmvc">https://github.com/pierangeloc/webshop-camel-springmvc</a> for an example of how to integrate Camel within an existing web application.</p>

<h3 id="simple-example">Simple Example</h3>
<p>Now that we outlined the base structure of a Camel-based application, letâ€™s try to put this at work and build a simple application. The purpose is just to show how we can have a working application with minimum effort. Let us suppose we have a simple ERP application that provides us periodically with an updated stock situation about our e-shop, and we want to provide this information to a third application, e.g. an analytics application. We want to expose a simple REST service, with one URL and supporting only POST method. The aim is to persist the body of our POST call in a file, in a configured location. A file will be created for every request.</p>

<h4 id="setup-rest-endpoint">Setup Rest Endpoint</h4>
<p>The most convenient way to expose or consume a REST or SOAP webservices in Camel is to use the CXF component. With CXF we can use <code>JAX-RS</code> and <code>JAX-WS</code> annotations to configure the service classes.</p>

<p>The first thing we must do is to setup the serving class that describes the resource we want to expose:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="kn">package</span> <span class="n">io</span><span class="o">.</span><span class="na">sytac</span><span class="o">.</span><span class="na">edu</span><span class="o">.</span><span class="na">rest</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.ws.rs.Consumes</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.ws.rs.POST</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.ws.rs.Path</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.ws.rs.Produces</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">javax.ws.rs.core.Response</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * Service class for our REST endpoint</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line">
</span><span class="line"><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/inventory/status&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">InventoryResource</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@POST</span>
</span><span class="line">    <span class="nd">@Consumes</span><span class="o">(</span><span class="s">&quot;application/json&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;application/json&quot;</span><span class="o">)</span>
</span><span class="line">    <span class="kd">public</span> <span class="n">Response</span> <span class="nf">updateStatus</span><span class="o">(</span><span class="n">String</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We provided a trivial implementation of the method, as the real implementation of the logic will be delegated to the route we are about to create. The JAX-RS annotations allow us to specify in a transparent way the supported content types, having the implementation actually enforcing them.
To make the endpoint available to our route, the most flexible way is to create a CXF bean that delegates to it, and to set it in our Spring context:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="o">&lt;</span><span class="n">beans</span> <span class="n">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
</span><span class="line">       <span class="nl">xmlns:</span><span class="n">xsi</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span class="line">       <span class="nl">xmlns:</span><span class="n">cxf</span><span class="o">=</span><span class="s">&quot;http://camel.apache.org/schema/cxf&quot;</span>
</span><span class="line">       <span class="nl">xsi:</span><span class="n">schemaLocation</span><span class="o">=</span><span class="s">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
</span><span class="line"><span class="s">              http://camel.apache.org/schema/cxf http://camel.apache.org/schema/cxf/camel-cxf.xsd</span>
</span><span class="line"><span class="s">              http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd&quot;</span><span class="o">&gt;</span>
</span><span class="line">
</span><span class="line">        <span class="o">&lt;</span><span class="nl">cxf:</span><span class="n">rsServer</span> <span class="n">id</span><span class="o">=</span><span class="s">&quot;restInventory&quot;</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;http://localhost:8000/services&quot;</span>
</span><span class="line">                <span class="n">serviceClass</span><span class="o">=</span><span class="s">&quot;io.sytac.edu.rest.InventoryResource&quot;</span> <span class="n">loggingFeatureEnabled</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="o">/&gt;</span>
</span><span class="line">
</span><span class="line"><span class="o">&lt;/</span><span class="n">beans</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we created a <code>cxf:rsServer</code> bean as we want it to serve requests, and specified the hostname, port, base url. The <code>serviceClass</code> attribute points to the class we defined above. Again, the implementation of this class is just ignored as the real processing of the request is specified in the route, which we are about to explore. </p>

<h4 id="routing">Routing</h4>
<p>Routes are specified in Camel by extending the abstract class  <code>RouteBuilder</code>, which provides all the Camel DSL goodness. All we have to do is implement the <code>configure() </code> method and specify the route(s). A route has one <em>consumer endpoint</em>, representing the point the processing starts from, and one or more <em>producer endpoints</em>, to represent delegation steps outside the present route, typically using <em>Camel components</em>.
In our case we want to consume requests coming to our REST resource, therefore we will specify this circumstance in the <code>from</code>. The <a href="http://camel.apache.org/cxfrs.html"><code>cxfrs</code></a> component is used to expose or consume rest services through CXF. Being used in a <code>from</code> clause means it is acting as a REST server. The <em>transport layer</em> is provided in our case by a <em>Jetty server</em> that we embed in our application, but a standard Servlet transport could be used as well when running within a container.</p>

<p>After the <code>from(...)</code> we specify the EIP that must be applied in our processing logic, and the DSL provides a natural and straightforward way to do so.
A simple, dummy  implementation of this concept applied to our use case results in this initial version of our route builder, that defines one route that accepts any JSON request and replies with a static JSON response. 
This allows us to inspect how a <code>Processor</code> works in Camel. All the processing steps in Camel are essentially done through a chain of <code>Processor</code> implementations, each acting on a mutable instance of <code>Exchange</code> (we will get back later to the details of the <code>Exchange</code>). The DSL implicitly introduces processors in a transparent way, however in an explicit <code>Processor</code> we can access directly the structure of the <code>Exchange</code>. To some extent we can do this also through the DSL, and in general using the DSL gives us a more consistent view of the processing, without the need to inspect the details of a specific <code>Processor</code> implementation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">process</span><span class="o">(</span>
</span><span class="line">                <span class="k">new</span> <span class="nf">Processor</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">Exchange</span> <span class="n">exchange</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">                        <span class="n">exchange</span><span class="o">.</span><span class="na">getOut</span><span class="o">().</span><span class="na">setBody</span><span class="o">(</span>
</span><span class="line">                                <span class="n">Response</span><span class="o">.</span><span class="na">ok</span><span class="o">().</span><span class="na">entity</span><span class="o">(</span>
</span><span class="line">                                    <span class="s">&quot;{\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                    <span class="s">&quot;  \&quot;status\&quot;: \&quot;OK\&quot;,\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                    <span class="s">&quot;  \&quot;message\&quot;: \&quot;stock update received\&quot;\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                    <span class="s">&quot;}&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">());</span>
</span><span class="line">                    <span class="o">}</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you <a href="https://github.com/sytac/camel-handson/commit/3a83bd88e6b4e9742d8330413ae5bcb2205ebba6">run the code at this check-point</a> you will see that the server is running and it accepts only JSON POST, replying always with the same message. </p>

<p>What happened exactly along the route?</p>

<p>The <code>cxf</code> component accepted the request, and mapped the body of the request in the body of the <code>In</code> message of the <code>Exchange</code>, and the request headers in equivalent message headers. At this point any processing step deals with the <em>normalized message structure</em> being the <code>Exchange</code>, and can access it and modify being completely agnostic of where it comes from (it could come equivalently from consuming a JMS queue) or where it will go to (file system or DB).</p>

<p>The equivalent version that uses purely DSL constructs looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="s">&quot;{\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                <span class="s">&quot;  \&quot;status\&quot;: \&quot;OK\&quot;,\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                <span class="s">&quot;  \&quot;message\&quot;: \&quot;stock update received\&quot;\n&quot;</span> <span class="o">+</span>
</span><span class="line">                                <span class="s">&quot;}&quot;</span><span class="o">))</span>
</span><span class="line">        <span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>or even better, using Jackson as a provider for CXF i.e. having the whole serialization being handled behind the scenes:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">&quot;Ok&quot;</span><span class="o">,</span> <span class="s">&quot;stock update received&quot;</span><span class="o">)));</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This requires only a slight complication on the configuration of the <code>rsServer</code>, to set the provider to a Jackson bean. In any case this pays off in terms of conciseness and clarity.</p>

<p><a href="https://github.com/sytac/camel-handson/commit/176bfd4949db3b5655827fdfa3259758326c15d0">Code check-point</a></p>

<h4 id="persisting-the-message-to-a-file">Persisting the message to a file</h4>
<p>After this diversion on the routing logic, letâ€™s focus again on our use case. We want to persist each JSON message we receive through the request body into a file, and we want a new file for each request to be written. The camel <a href="https://camel.apache.org/file2.html">File component</a> provides a flexible and straightforward way to do so. We must simply introduce a step that sends the <code>Exchange</code> to the <code>file</code> component, that takes care of all the boilerplate and tricky parts we have to deal with when writing on file system in a concurrent environment.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;file:///tmp/inventory?fileName=inventory-${date:now:yyyyMMdd@HHmmssSS}.json&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">&quot;Ok&quot;</span><span class="o">,</span> <span class="s">&quot;stock update received&quot;</span><span class="o">)));</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In general components in Camel are addressed by means of a url where the protocol represents the component we want to use, followed by a base url and a query string to configure and tweak the component itself. In this case we instruct <code>file</code> on how to create the file name, by means of the <em>simple expression language</em> which is very useful in Camel when we have to deal with dynamic content. In this case we want the file name to contain a simple timestamp.
If we run this example, we can see that for every request there is a new file created and saved with the name we defined. We didnâ€™t have to bother about serializing/deserializing anything, as Camel did this for us. It is even possible to configure the components to deal properly with <em>streaming</em> situations, e.g. when we have to upload resources.</p>

<p><a href="https://github.com/sytac/camel-handson/commit/ec3b524e495b630154a5cbbc6ce89d8a7d39edee">Code check-point</a></p>

<h4 id="persisting-the-message-to-a-file-and-to-mongodb">Persisting the message to a file and to MongoDB</h4>
<p>Let us suppose we want to store the incoming JSON on a MongoDB collection instead of file system. Of course Camel provides us with a component for this case, just it requires us to add an extra dependency:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="XML"><span class="line"><span class="nt">&lt;dependency&gt;</span>
</span><span class="line">    <span class="nt">&lt;groupId&gt;</span>org.apache.camel<span class="nt">&lt;/groupId&gt;</span>
</span><span class="line">    <span class="nt">&lt;artifactId&gt;</span>camel-mongodb<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="line">    <span class="nt">&lt;version&gt;</span>${camel.version}<span class="nt">&lt;/version&gt;</span>
</span><span class="line"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we must just configure a <code>MongoClient</code> bean in our Spring context:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mongoClient&quot;</span><span class="o">)</span>
</span><span class="line"><span class="kd">public</span> <span class="n">Mongo</span> <span class="nf">mongoDb</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">UnknownHostException</span> <span class="o">{</span>
</span><span class="line">    <span class="c1">//default port on localhost</span>
</span><span class="line">    <span class="k">return</span> <span class="k">new</span> <span class="nf">MongoClient</span><span class="o">(</span><span class="s">&quot;localhost&quot;</span><span class="o">,</span> <span class="mi">27017</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and then the ceremony is over. All we are left to do is replacing our <code>file</code> component with a <code>mongodb</code> component, configured to use the <code>mongoClient</code> bean above defined, and to use the <code>inventory</code> database, with <code>updates</code>  as collection, and <code>save</code> operation (as we are saving our data in the collection).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;mongodb:mongoClient?database=inventory&amp;collection=updates&amp;operation=save&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">&quot;Ok&quot;</span><span class="o">,</span> <span class="s">&quot;stock update received&quot;</span><span class="o">)));</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If we run this code we can see that for every POST to our REST api we have an insertion on our database.
<a href="https://github.com/sytac/camel-handson/commit/b85dc966736fc4bc669fbbc2f7b80050dfa4661b">Code check-point</a></p>

<p>We can even decide to store the message both on file system and on Mongo, and the route looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;file:///tmp/inventory?fileName=inventory-${date:now:yyyyMMdd@HHmmssSS}.json&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="s">&quot;mongodb:mongoClient?database=inventory&amp;collection=updates&amp;operation=save&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">&quot;Ok&quot;</span><span class="o">,</span> <span class="s">&quot;stock update received&quot;</span><span class="o">)));</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><a href="https://github.com/sytac/camel-handson/commit/0f72b67e863b4f0415955938d89e9184a47fcf3b">Code check-point</a></p>

<h4 id="adding-routing-logic">Adding routing logic</h4>
<p>In the previous example we have stored the same message both on DB and filesystem. We might think to split the incoming message based on its structure, and store e.g. some jeans related stock information on DB and the shoes related information on filesystem.</p>

<p>For this kind of purposes an easy approach is to introduce a <code>when</code> clause where we can specify <code>jsonpath</code> expressions that our input message must match in order to be treated the way we need.
For this exercise we will deal with shoes inventory updates that will be persisted on file:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="JSON"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="nt">&quot;shoes&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span class="line">                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Nike AIR&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Running shoes&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC1&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC2&quot;</span><span class="p">:</span> <span class="mi">23</span>
</span><span class="line">            <span class="p">},</span>
</span><span class="line">            <span class="p">{</span>
</span><span class="line">                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Adidas Ultra Boost&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Running shoes&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC1&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC2&quot;</span><span class="p">:</span> <span class="mi">3</span>
</span><span class="line">            <span class="p">},</span>
</span><span class="line">            <span class="p">{</span>
</span><span class="line">                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;TOD&#39;s Suede&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Sneakers&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC1&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC2&quot;</span><span class="p">:</span> <span class="mi">9</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and jeans inventory messages that will be persisted on DB:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="JSON"><span class="line"><span class="p">{</span>
</span><span class="line">    <span class="nt">&quot;jeans&quot;</span><span class="p">:</span> <span class="p">[{</span>
</span><span class="line">                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Levi&#39;s 501&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Blue jeans&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC1&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC2&quot;</span><span class="p">:</span> <span class="mi">10</span>
</span><span class="line">            <span class="p">},</span>
</span><span class="line">            <span class="p">{</span>
</span><span class="line">                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Diesel&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Blue jeans&quot;</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC1&quot;</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>
</span><span class="line">                <span class="nt">&quot;DC2&quot;</span><span class="p">:</span> <span class="mi">7</span>
</span><span class="line">            <span class="p">}</span>
</span><span class="line">    <span class="p">]</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We want also to deal with messages that do not conform to any of these 2 options, saving them in corresponding error files (we could also send them alternatively to a <em>dead letter queue</em>) .</p>

<p>The solution is very straightforward, it just might take a bit if you are new to jsonpath expressions:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="nd">@Component</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SimpleRouteBuilder</span> <span class="kd">extends</span> <span class="n">RouteBuilder</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FILE_INVENTORY_ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;file:///tmp/inventory?fileName=inventory-${date:now:yyyyMMdd@HHmmssSS}.json&quot;</span><span class="o">;</span>
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">MONGO_INVENTORY_ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;mongodb:mongoClient?database=inventory&amp;collection=updates&amp;operation=save&quot;</span><span class="o">;</span>
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">FILE_ERROR_ENDPOINT</span> <span class="o">=</span> <span class="s">&quot;file:///tmp/inventory?fileName=error-${date:now:yyyyMMdd@HHmmssSS}.json&quot;</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configure</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">        <span class="n">from</span><span class="o">(</span><span class="s">&quot;cxfrs:bean:restInventory&quot;</span><span class="o">)</span>
</span><span class="line">            <span class="o">.</span><span class="na">routeId</span><span class="o">(</span><span class="s">&quot;restInventoryRoute&quot;</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">choice</span><span class="o">()</span>
</span><span class="line">                    <span class="o">.</span><span class="na">when</span><span class="o">().</span><span class="na">jsonpath</span><span class="o">(</span><span class="s">&quot;$[?(@.shoes)]&quot;</span><span class="o">)</span>
</span><span class="line">                        <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">FILE_INVENTORY_ENDPOINT</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">when</span><span class="o">().</span><span class="na">jsonpath</span><span class="o">(</span><span class="s">&quot;$[?(@.jeans)]&quot;</span><span class="o">)</span>
</span><span class="line">                        <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">MONGO_INVENTORY_ENDPOINT</span><span class="o">)</span>
</span><span class="line">                    <span class="o">.</span><span class="na">otherwise</span><span class="o">()</span>
</span><span class="line">                        <span class="o">.</span><span class="na">to</span><span class="o">(</span><span class="n">FILE_ERROR_ENDPOINT</span><span class="o">)</span>
</span><span class="line">                <span class="o">.</span><span class="na">end</span><span class="o">()</span>
</span><span class="line">            <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="n">constant</span><span class="o">(</span><span class="k">new</span> <span class="nf">Response</span><span class="o">(</span><span class="s">&quot;Ok&quot;</span><span class="o">,</span> <span class="s">&quot;stock update received&quot;</span><span class="o">)));</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>choice</code> clause allows us to specify any predicate or expression we might want to evaluate on the incoming <code>Exchange</code>, in this case as we know we are dealing with JSON body so we make direct use of the <a href="http://goessner.net/articles/JsonPath/"><code>jsonpath</code></a> construct. Camel Expression language is very rich and it might be subject of a future post. </p>

<p><a href="https://github.com/sytac/camel-handson/commit/f3e17df4b817da441550aa9eab58fed07a0ae0b6">Code check-point</a></p>

<p>At this point I think the concept about Camel routing is pretty clear, and you can appreciate how easy it is to make use of the components and of the routing logic. Just looking at the DSL we can understand and reason about the processing steps our data go through. In a future post we will explore further some of the DSL routing features, e.g. how to handle errors or perform testing.</p>

<p>I will close this article with an overview of the structural foundations of Camel and recurring concepts that will appear any time you have to deal with it.</p>

<h3 id="camel-foundations">Camel foundations</h3>
<p>Camel is built around some key concepts that we will try to explain in this section: <code>CamelContext</code>, <code>RouteBuilder</code>, <code>Endpoint</code> <code>Exchange</code>, <code>Message</code>, <code>ProducerTemplate</code></p>

<h4 id="camelcontext"><code>CamelContext</code></h4>
<p>The foundation on top of which all the Camel machinery runs is the <code>CamelContext</code>, which is in control of the lifecycle of the routes and messages running on it. A <code>CamelContext</code> can be started/suspended/resumed/stopped, and it provides a number of configuration tweaks, e.g. to handle the underlying <code>ExecutorService</code>.
A <code>CamelContext</code> can manage many <em>routes</em>, which represent processing paths for <em>messages</em>.</p>

<h4 id="routebuilder"><code>RouteBuilder</code></h4>
<p>A <code>Route</code> is a description of the processing steps a message can encounter. A route starts from a <em>consumer</em> endpoint that consumes messages and processes them, and can end to a <em>producer</em> endpoint if the messages must result in an outcome of some type (e.g. a call to a webservice, or a message on a JMS queue). The standard way to create a <code>Route</code> in Camel is to inject a <code>RouteBuilder</code> in the <code>CamelContext</code> and override its <code>define()</code> method.
The <code>RouteBuilder</code> class provides the Camel DSL which makes the implementation of EIP straightforward. We will see later a few examples of routes.</p>

<h4 id="endpoint"><code>Endpoint</code></h4>
<p>A <code>Route</code> could not process messages without a source of these messages, which is a <em>consumer</em> endpoint, and without a destination to which messages can be delivered after being processed, a <em>producer</em> endpoint. The concept of <em>endpoint</em> is itself an EIP <a href="http://www.enterpriseintegrationpatterns.com/MessageEndpoint.html">http://www.enterpriseintegrationpatterns.com/MessageEndpoint.html</a> and it is a cornerstone of the Camel solution to the integration problem: regardless of the nature of the producer or consumer endpoint, the intermediate steps deal with a message that have a standard structure and is in general agnostic about the nature of the source or destination of the message. The processing steps along the route deal with the same type of message, whether it came to the route through a webservice exposed by the route, or because it has been delivered as a file on a directory the route is listening to. The webservice, or the file listening service in this case, are different implementations of a <em>consuming</em> endpoint.</p>

<h4 id="exchange"><code>Exchange</code></h4>
<p>Endpoints can produce or consume <code>Exchange</code>s. An <code>Exchange</code> is structured in an IN and an OUT message. When dealing with a <em>consumer endpoint</em>, we can see it as a source of <code>Exchange</code>s with IN message. The processing steps along the route can modify the IN message and ultimately populate the OUT message that is used by the consumer endpoint as a response (imagine the IN/OUT pattern as a mapping of the Request/Response pattern)</p>

<h4 id="message"><code>Message</code></h4>
<p>The IN/OUT <code>Message</code>s in the exchange have a standard structure, being constituted of header, body and attachments. The processing steps can read or modify freely each of these parts, being all these mutable structures.</p>

<h4 id="producertemplate"><code>ProducerTemplate</code></h4>
<p>In testing scenarios, or in situations where messages are not consumed from a Camel endpoint, you might want to create an Exchange and send it to an endpoint. This can happen e.g. when you are integrating Camel in an existing web  application, and you want to use it to handle only one part of the request/response cycle, delegating the final handling to the existing framework (e.g. to a Spring Controller). Moreover, you want to be completely sure of not ending up in thread safety problems. 
For these cases the <code>CamelContext</code> provides with an instance of <code>ProducerTemplate</code> which allows to ultimately synthesize on the flight an <code>Exchange</code> and send it to an endpoint, all in a <em>thread safe manner</em>. <code>ProducerTemplate</code> provides a number of methods to build an <code>Exchange</code>.</p>

<h3 id="conclusions">Conclusions</h3>
<p>In this post we just scraped the surface of Camel, and there is a lot more to discover. I will try in future posts to dive further into features of Camel that I find particularly interesting, e.g. the testing support, parallel processing features, integration with Akka.</p>

<p>The way the Camel DSL is structured provides a way to write code in linear manner, making it easier to reason about, and even <em>visualize it</em> (through the DSL and through HawtIO which we will explore later), and it tackles the problems of modularity of an application. For example we could just split any processing flow in subroutes and replace only those when necessary, provided the structure of the <code>Exchange</code> up and downstream is preserverd. This also fits perfectly with the need of distributing work in a team without risking of stepping in each othersâ€™ toes. If we consider also that a very natural way of deploying routes is through OSGi bundles (this is the principle followed in  <a href="http://www.jboss.org/products/fuse/overview">JBoss Fuse</a>), we can see how allowing modularity is one of the core principles at the base of this project, and it has definitely been achieved.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/12/scalajs-for-dynamic-systems-simulation/">Scala.js for Dynamic Systems Simulation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-12T10:13:14+02:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-04-12T10:13:14+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span></time></time>
        
         | <a href="/blog/2015/04/12/scalajs-for-dynamic-systems-simulation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>After the Scaladays 2015 in SF, a lot of echo has involved the <a href="http://www.scala-js.org">Scala.js</a> framework. Scala.js compiles Scala code into Javascript code, which can be run in a browser but also on Javascript powered server environments e.g. Node.js.</p>

<p>Scala.js is not something like GWT, which provided a whole toolkit for Javascript code generation from Java. Scala.js is simply a compiler that translates Scala code into Javascript code. This allows to use all the great features that make Scala such a successful language, like strong typing, functional code, higher order functions, case classes, pattern matching, and even Future and Promises (when dealing e.g. with events on the client or with Ajax calls). 
For some parts it is possible to develop code that is fully agnostic of the target platform, i.e. you can write some Scala code that can be executed equivalently on a JVM or on a browser when compiled with Scala.js. For the parts that deal with HTML elements or with Ajax, the target platform must be taken into consideration.
The advantage that Scala.js offers is, on top of the pleasure of using a concise and expressive language like Scala, that due to the strong typing it allows to discover errors already in the compilation phase, while as we know when we develop logic in Javascript, most of the times we discover errors only at runtime.</p>

<p>To show all the goodness of Scala.js I could have written a simple game, but there are already plenty of these examples around. Being this the blog of a real nerd, in this post we will use Scala.js to build a simulator of dynamic systems running on a browser, with the aim to draw a <a href="http://en.wikipedia.org/wiki/Phase_portrait">phase portrait</a> of a system described by a 2-dimensional <a href="http://en.wikipedia.org/wiki/Ordinary_differential_equation">ODE</a>. The source code used in along this post can be found  <a href="https://github.com/pierangeloc/PhasePortraitJS">here</a>.</p>

<h4 id="sbt-project-setup">SBT project setup</h4>
<p>For a full introduction to Scala.js please refer to the great guide <a href="http://lihaoyi.github.io/hands-on-scala-js/">http://lihaoyi.github.io/hands-on-scala-js/</a>. The layout of my project follows exactly the structure outlined in that guide.
To setup an SBT project to use Scala.js you simply must add the corresponding plugin in the <code>plugins.sbt</code> file. I added also the <a href="https://github.com/lihaoyi/workbench">Workbench plugin</a> which proved to be very useful to test your code on the browser:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;org.scala-js&quot;</span> <span class="o">%</span> <span class="s">&quot;sbt-scalajs&quot;</span> <span class="o">%</span> <span class="s">&quot;0.6.1&quot;</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">addSbtPlugin</span><span class="o">(</span><span class="s">&quot;com.lihaoyi&quot;</span> <span class="o">%</span> <span class="s">&quot;workbench&quot;</span> <span class="o">%</span> <span class="s">&quot;0.2.3&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In the <code>build.sbt</code> file we must enable the <code>ScalaJSPlugin</code>  and add the dependency from the scalajs-dom library that allows us to access the DOM elements (and events) from Scala, in a typesafe fashion.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">enablePlugins</span><span class="o">(</span><span class="nc">ScalaJSPlugin</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class="line">  <span class="s">&quot;org.scala-js&quot;</span> <span class="o">%%%</span> <span class="s">&quot;scalajs-dom&quot;</span> <span class="o">%</span> <span class="s">&quot;0.8.0&quot;</span>
</span><span class="line"><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="n">bootSnippet</span> <span class="o">:=</span> <span class="s">&quot;drawing.ScalaJSPhasePortrait().main(document.getElementById(&#39;canvas&#39;));&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">updateBrowsers</span> <span class="o">&lt;&lt;=</span> <span class="n">updateBrowsers</span><span class="o">.</span><span class="n">triggeredBy</span><span class="o">(</span><span class="n">fastOptJS</span> <span class="n">in</span> <span class="nc">Compile</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>bootSnippet</code> line is used just to configure Workbench to execute that  Javascript to start the application on the browser, and the <code>updateBrowsers</code> line is used to trigger the boot at the end of each compilation phase.  </p>

<h4 id="coding">Coding</h4>
<p>In the project folder  <code>/src/main/scala</code>  we put our Scala code that will be then compiled into equivalent Javascript. We need to define one or more exposed points, i.e. a Scala Object that we want to be translated in Javascript, on which we can invoke one or more methods. Both the Object and the methods must be marked properly for export, by means of the <code>@JSExport</code> annotation:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="k">package</span> <span class="nn">drawing</span>
</span><span class="line">
</span><span class="line"><span class="c1">// ...</span>
</span><span class="line">
</span><span class="line"><span class="nd">@JSExport</span>
</span><span class="line"><span class="k">object</span> <span class="nc">ScalaJSPhasePortrait</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@JSExport</span>
</span><span class="line">  <span class="k">def</span> <span class="n">realPendulumPhasePortrait</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@JSExport</span>
</span><span class="line">  <span class="k">def</span> <span class="n">simplePendulumPhasePortrait</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="c1">// ...</span>
</span><span class="line">
</span><span class="line">  <span class="nd">@JSExport</span>
</span><span class="line">  <span class="k">def</span> <span class="n">lotkaVolterraPhasePortrait</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Canvas</span><span class="o">)</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="c1">// ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we are exposing the <code>drawing.ScalaJSPhasePortrait</code> object and 3 methods <code>realPendulumPhasePortrait</code>,  <code>simplePendulumPhasePortrait</code> and <code>lotkaVolterraPhasePortrait</code>, each of them expecting a Canvas object as input. The compiler will start from these exposed entities and transitively include everything is <em>strictly required</em> by the code in order to function. This means that if a method uses some features provided by another class, possibly provided by a separate library, only the required features are included in the translation package and not the whole library. There is no limit to the number of objects or functions you might want to expose in your application.</p>

<p>When we run</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="bash"><span class="line"> sbt ~fastOptJS
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>we trigger the code generation (the <code>~</code> is a standard SBT feature that allows code to be regenerated whenever something changes in the source files). If we inspect the <code>/target</code> folder in the project we can see that a file <code>target/scala-2.11/phaseportraitjs-fastopt.js</code> has been created. This is the output of the Scala.js compiler. The name of this file is determined by the SBT project name, and this is the file that must be included in our HTML page in order to have our example working. We can then invoke the <code>drawing.ScalaJSPhasePortrait</code> object methods from any point in our browser. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="HTML"><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;../phaseportraitjs-fastopt.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/workbench.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class="line"><span class="nt">&lt;script&gt;</span>
</span><span class="line">    <span class="nx">drawing</span><span class="p">.</span><span class="nx">ScalaJSPhasePortrait</span><span class="p">().</span><span class="nx">simplePendulumPhasePortrait</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;simplePendulum&#39;</span><span class="p">));</span>
</span><span class="line">    <span class="nx">drawing</span><span class="p">.</span><span class="nx">ScalaJSPhasePortrait</span><span class="p">().</span><span class="nx">realPendulumPhasePortrait</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;realPendulum&#39;</span><span class="p">));</span>
</span><span class="line">    <span class="nx">drawing</span><span class="p">.</span><span class="nx">ScalaJSPhasePortrait</span><span class="p">().</span><span class="nx">lotkaVolterraPhasePortrait</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;lotkaVolterra&#39;</span><span class="p">));</span>
</span><span class="line"><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="the-problem">The problem</h4>

<p><div class="bogus-wrapper"><notextile>
An autonomous dynamical system in $\mathbb{R}^n$ is described by a system of differential equations that can be represented as:
\[
\dot x = f(x),\ x \in \mathbb{R}^n
\]

Being the system autonomous means that the field described by the function  $f$ does not depend from time, and this means that the evolution of the movement $x(t)$ given some initial condition $x_0$ depends only from $x_0$ and not from the particular initial time (there is an invariance on time shift).

This allows us to provide a good description of the evolution of the system by describing the orbits of the sytem, i.e. the values that $x(t)$ assumes regardless of the time. This type of qualitative analysis is important when describing systems for which we don&#8217;t know an exact solution.
</notextile></div></p>

<p>In our Scala.js application we want to provide a general solution for this problem, for systems of dimension 2, so that their evolution can be easily represented on a 2-dimensional space, in our case an HTML Canvas.</p>

<p>We need to separate the concerns of drawing something on a given rectangle from those of calculating the evolution of a dynamic system.</p>

<h4 id="drawing-points-on-a-rectangular-area">Drawing points on a rectangular area</h4>
<p>The starting point is the HTML Canvas that has a given size, and the window of $\mathbb{R}^2$ we want to represent on it. For convenience we allow the window center and sizes to assume only integer values. The window is a simple case class:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">DrawingWindow</span><span class="o">(</span><span class="n">canvas</span><span class="k">:</span> <span class="kt">Canvas</span><span class="o">,</span> <span class="n">centerX</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">centerY</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">halfWidth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">halfHeight</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">val</span> <span class="n">deltaX</span> <span class="k">=</span> <span class="n">halfWidth</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">canvas</span><span class="o">.</span><span class="n">width</span>
</span><span class="line">  <span class="k">val</span> <span class="n">deltaY</span> <span class="k">=</span> <span class="n">halfHeight</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">canvas</span><span class="o">.</span><span class="n">height</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>deltaX</code> and <code>deltaY</code> values represent the resolution of our window on the given canvas.
The <code>Plot</code> class provides all the methods we need to deal with the window on the canvas and to plot dots and curves on it.</p>

<p>The mathematical points are represented by the case class <code>Point</code>, on which we defined the standard operation on the vector space $\mathbb{R}^2$:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="k">case</span> <span class="k">class</span> <span class="nc">Point</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">y</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">  <span class="k">def</span> <span class="o">+(</span><span class="n">other</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span><span class="o">)</span>
</span><span class="line">  <span class="k">def</span> <span class="o">-(</span><span class="n">other</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">x</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">y</span><span class="o">)</span>
</span><span class="line">  <span class="k">def</span> <span class="o">*(</span><span class="n">factor</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Point</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">factor</span><span class="o">,</span> <span class="k">this</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="n">factor</span><span class="o">)</span>
</span><span class="line">  <span class="k">def</span> <span class="n">abs</span> <span class="k">=</span> <span class="nc">Math</span><span class="o">.</span><span class="n">sqrt</span><span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">y</span><span class="o">)</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We can appreciate how easily Scala case classes and operators allow us to represent algebraic entities and operators like we are used to do in Algebra. Doing the same thing in Java would have taken many more lines of code and would have lacked expressiveness.
The transformation from a <code>Point</code> to a <code>CanvasPoint</code> is performed by the <code>point2CanvasPoint(p: Point): CanvasPoint</code> function in the <code>Plot</code> class.
A <code>drawGrid()</code> function uses <code>for</code> comprehensions to draw the grid on the window:</p>

<p><img src="/images/posts/grid.png" alt="alt text" title="Grid on Canvas" /></p>

<p>To draw points on the canvas we simply draw little circles around each point, you can check the source code for the details.</p>

<h4 id="calculating-the-evolution-of-the-system-from-initial-conditions">Calculating the evolution of the system from initial conditions</h4>
<p>In order to plot the phase portrait we begin defining a set of initial points to start the evolution from. In our case we pick the points on the grid with integer coordinates. Once we have this initial condition $x_0$ we must simulate the evolution $x(t)$ that solves our differential equation starting from $x_0$: $x(0) = x_0$. If we do this repeatedly for each initial condition in our grid, we end up with a phase portrait.</p>

<p>To calculate the evolution we use the 4th order Runge-Kutta algorithm (see <a href="http://www.myphysicslab.com/runge_kutta.html">here</a> for the details).
We sample the solution in regular time intervals $0,\ \Delta t,\ 2\Delta t,\ $ etc. The sequence of values of $x(t)$ is represented by a <code>Stream</code> that we build through the <code>iterate</code> function needs the head of the <code>Stream</code> and the function to produce the next sample given the current one, on demand, so it fits perfectly with our needs.
If we represent our function $f$ as <code>f: Point =&gt; Point</code>, the whole evolution machinery is represented by this function (we translated almost verbatim the mathematical formula of the Runge-Kutta method):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="c1">//evolution of a dynamic system in R2 (RK 4th order)</span>
</span><span class="line"><span class="k">def</span> <span class="n">evolution</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Point</span> <span class="o">=&gt;</span> <span class="nc">Point</span><span class="o">,</span> <span class="n">x0</span><span class="k">:</span> <span class="kt">Point</span><span class="o">,</span> <span class="n">deltaT</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[(</span><span class="kt">Double</span>, <span class="kt">Point</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">iterate</span><span class="o">((</span><span class="mf">0.0</span><span class="o">,</span> <span class="n">x0</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">  <span class="k">case</span> <span class="o">(</span><span class="n">tn</span><span class="k">:</span> <span class="kt">Double</span><span class="o">,</span> <span class="n">xn</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">    <span class="k">val</span> <span class="n">an</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">xn</span><span class="o">)</span>
</span><span class="line">    <span class="k">val</span> <span class="n">bn</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">xn</span> <span class="o">+</span> <span class="o">(</span><span class="n">an</span> <span class="o">*</span> <span class="o">(</span><span class="n">deltaT</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)))</span>
</span><span class="line">    <span class="k">val</span> <span class="n">cn</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">xn</span> <span class="o">+</span> <span class="o">(</span><span class="n">bn</span> <span class="o">*</span> <span class="o">(</span><span class="n">deltaT</span> <span class="o">/</span> <span class="mi">2</span><span class="o">)))</span>
</span><span class="line">    <span class="k">val</span> <span class="n">dn</span> <span class="k">=</span> <span class="n">f</span><span class="o">(</span><span class="n">xn</span> <span class="o">+</span> <span class="o">(</span><span class="n">cn</span> <span class="o">*</span> <span class="o">(</span><span class="n">deltaT</span><span class="o">)))</span>
</span><span class="line">
</span><span class="line">    <span class="o">(</span><span class="n">tn</span> <span class="o">+</span> <span class="n">deltaT</span><span class="o">,</span> <span class="n">xn</span> <span class="o">+</span> <span class="o">(</span><span class="n">an</span> <span class="o">+</span> <span class="n">bn</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">cn</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dn</span><span class="o">)</span> <span class="o">*</span> <span class="o">(</span><span class="n">deltaT</span> <span class="o">/</span> <span class="mi">6</span><span class="o">))</span>
</span><span class="line">  <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Given the function <code>f</code>, the initial point <code>x0</code> and the sampling interval <code>deltaT</code> the <code>evolution</code> function provides us with a stream of pairs <code>(tn, xn)</code> that represent the evolution of the system.</p>

<p>If we take a given number of samples and we plot them, we have one orbit for a given initial condition. If we do that for all the points with integer coordinates in our grid, we have a complete phase portrait for the system described by the function <code>f</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"> <span class="k">def</span> <span class="n">phasePortrait</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Point</span> <span class="o">=&gt;</span> <span class="nc">Point</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class="line">      <span class="k">val</span> <span class="n">verticalLines</span> <span class="k">=</span> <span class="o">(</span><span class="n">drawingWindow</span><span class="o">.</span><span class="n">centerX</span> <span class="o">-</span> <span class="n">drawingWindow</span><span class="o">.</span><span class="n">halfWidth</span><span class="o">)</span> <span class="n">to</span> <span class="o">(</span><span class="n">drawingWindow</span><span class="o">.</span><span class="n">centerX</span> <span class="o">+</span> <span class="n">drawingWindow</span><span class="o">.</span><span class="n">halfWidth</span><span class="o">)</span>
</span><span class="line">      <span class="k">val</span> <span class="n">horizontalLines</span> <span class="k">=</span> <span class="o">(</span><span class="n">drawingWindow</span><span class="o">.</span><span class="n">centerY</span> <span class="o">-</span> <span class="n">drawingWindow</span><span class="o">.</span><span class="n">halfHeight</span><span class="o">)</span> <span class="n">to</span> <span class="o">(</span><span class="n">drawingWindow</span><span class="o">.</span><span class="n">centerY</span> <span class="o">+</span> <span class="n">drawingWindow</span><span class="o">.</span><span class="n">halfHeight</span><span class="o">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">for</span> <span class="o">{</span>
</span><span class="line">        <span class="n">x</span> <span class="k">&lt;-</span> <span class="n">verticalLines</span>
</span><span class="line">        <span class="n">y</span> <span class="k">&lt;-</span> <span class="n">horizontalLines</span>
</span><span class="line">      <span class="o">}</span> <span class="o">{</span>
</span><span class="line">          <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;x0 = ${Point(x, y)}&quot;</span><span class="o">)</span>
</span><span class="line">          <span class="c1">//rgb to plot the orbit with 1 color</span>
</span><span class="line">          <span class="k">val</span> <span class="n">rgb</span> <span class="k">=</span> <span class="n">s</span><span class="s">&quot;rgb(${Random.nextInt(256)},${Random.nextInt(256)},${Random.nextInt(256)})&quot;</span>
</span><span class="line">
</span><span class="line">          <span class="n">evolution</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">)).</span><span class="n">map</span> <span class="o">{</span>
</span><span class="line">            <span class="k">case</span> <span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">p</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">{</span>
</span><span class="line">              <span class="n">plotter</span><span class="o">.</span><span class="n">draw</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">rgb</span><span class="o">)</span>
</span><span class="line">              <span class="n">p</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">          <span class="o">}</span> <span class="n">take</span><span class="o">(</span><span class="mi">3000</span><span class="o">)</span> <span class="n">toList</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You can see that we used here the Scala <code>println</code> function. The code generated in ScalaJS has the very convenient feature that all these instructions are translated into browser console logs.</p>

<p>Now we can define the system we want to simulate simply by defining the corresponding function $f$:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="k">val</span> <span class="n">omega</span> <span class="k">=</span> <span class="mf">1.0</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">simplePendulum</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">,</span> <span class="o">-</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">realPendulum</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">,</span> <span class="o">-</span> <span class="n">omega</span> <span class="o">*</span> <span class="n">omega</span> <span class="o">*</span> <span class="nc">Math</span><span class="o">.</span><span class="n">sin</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">))</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">lotkaVolterra</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">,</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="n">vanDerPol</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Point</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Point</span><span class="o">(</span><span class="n">x</span><span class="o">.</span><span class="n">y</span><span class="o">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="o">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">)</span> <span class="o">*</span> <span class="n">x</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">x</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>and pass this function to our <code>phasePortrait</code> that takes care of plotting the corresponding phase portrait in the given Canvas. Here are a couple of examples:</p>

<p><strong>Pendulum</strong>
<img src="/images/posts/pendulum.png" alt="alt text" title="Pendulum phase portrait" /></p>

<p>We can clearly identify the single orbits (from the given color). The further we move from the horizontal axis, the higher is the speed and therefore our samples are getting more sparse. An adaptive sampling algorithm would have helped us having a better drawing, but the essence of the implementation does not change.</p>

<p><strong>Van der Pol</strong>
<img src="/images/posts/vanDerPol.png" alt="alt text" title="Van der Pol equation phase portrait" /></p>

<p>We can see that in this system all the orbits end up overlapping with a given, globally attracting, orbit. This is a clear phenomenom of <em>limit cycle</em>, examples of which we have also in the discrete world, e.g. in digital signal processing.</p>

<h4 id="conclusion">Conclusion</h4>
<p>We have seen how Scala.js is a convenient way to build code running on any Javascript powered platform, using the great features of the Scala language. </p>

<p>It is also a nice way to translate Scala code, which tends to be very generic and applicable to different types, into visual components easily accessible to anyone and not only to people with technical skills.</p>

<p>The <code>evolution</code> function provided above can be used to simulate any system of dimension 2, and easily adapted to simulate any dynamic system described by a differential equation, even in the time-dependent case (it is sufficient to increase the dimension of one and obtain an equivalent autonomous system).</p>

<p>The <code>Plot</code> class can be reused to plot any kind of curve on a given window on the Cartesian plane.  </p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/06/integrals-in-scala/">A Simple Scala Application: Calculating Integrals</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-06T20:57:33+02:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-04-06T20:57:33+02:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span></time></time>
        
         | <a href="/blog/2015/04/06/integrals-in-scala/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I embraced functional programming through Scala starting with the great Marting Oderskyâ€™s course in Coursera, following with the Reactive Programming course in Coursera (a second edition of which will start shortly and I really recommend you to sign up and follow it), and later on working with Play framework and Akka streams.</p>

<p>I spent a few years programming in Java in a purely imperative way, and as soon as I could understand the functional approach, I realized it is a great way to focus on the essence of the problem, and it provides a more organic way to decompose reasoning and handling complexity.</p>

<p>Of course the language itself doesnâ€™t guarantee that the approach is functional: if you want you can write Scala almost like Java without semicolons. But despite not being purely functional and allowing mutable variables, Scala provides all the features to put in practice purely functional approach. Moreover the syntax is very similar to Java so the transition from Java, from the language point of view, is pretty smooth.</p>

<p>When I have seen the first examples of functional code I appreciated the fact that it provides the language tools to model directly mathematical functions. For example a mathematical function $f$ from $A$ to $B$:</p>
<p><div class="bogus-wrapper"><notextile>

\[
f: A \rightarrow B
\]
</notextile></div></p>

<p>is translated into a definition of a function in Scala as (the <code>???</code> mean that the function is still undefined):</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">f</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=&gt;</span> <span class="nc">Double</span> <span class="k">=</span> <span class="o">???</span>
</span><span class="line"><span class="n">f</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=&gt;</span> <span class="nc">Double</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Functions in Scala are first class citizens, and they can be passed as arguments to other functions. This allows to compose things in a very straightforward way that procedural programming simply wouldnâ€™t allow. </p>

<p><div class="bogus-wrapper"><notextile>
Consider for example calculating the integral of the $\sin(x)$ function over the interval $[0, \pi]$, which we know from our math classes being 2. We map real numbers to their finite precision representation as Double, and we can have a Scala definition of $\sin(x), x \in \mathbb{R}$ as

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="k">def</span> <span class="n">f</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=&gt;</span> <span class="nc">Double</span> <span class="k">=</span> <span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Math</span><span class="o">.</span><span class="n">sin</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

or even more concisely

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">Math.sin</span>
</span><span class="line"><span class="k">import</span> <span class="nn">Math.sin</span>
</span><span class="line"><span class="n">scala</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">f</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=&gt;</span> <span class="nc">Double</span> <span class="k">=</span> <span class="n">sin</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>
</span><span class="line"><span class="n">f</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=&gt;</span> <span class="nc">Double</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

Now we can pproximate the integral with a finite sum:
\[
\int_0^{\pi}\sin(x)dx &#92;approx \Delta x \sum_{n=0}^{N}\sin(x_n) 
\]
with $\Delta x = \pi / N$ and $x_n = n\Delta x$.
</notextile></div></p>

<p>We know the explicit way of finding N given $\Delta x$ and $\pi$, however letâ€™s exploit a great feature of Scala which are <code>Stream</code>s and lazy evaluation (see http://www.scala-lang.org/api/2.11.5/index.html#scala.collection.immutable.Stream).
We can define the <code>Stream</code> of $x_n$ as a potentially unbounded sequence of doubles, with the guarantee that the next number will be generated on demand, lazily, only when required:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">deltaX</span> <span class="k">=</span> <span class="mf">0.01</span>
</span><span class="line"><span class="n">deltaX</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">0.01</span>
</span><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">xn</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="mf">0.0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="n">deltaX</span><span class="o">)</span>
</span><span class="line"><span class="n">xn</span><span class="k">:</span> <span class="kt">scala.collection.immutable.Stream</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we did two things: we created a <code>Stream</code>, where no value is allocated yet, all the  values of which are created on demand, and we defined it with a <code>def</code> and not with a <code>val</code> in order to save memory allocation once we consumed the stream, as we want just the $x_n$ to be produced to generate the sum and we donâ€™t want to retain it afterwards.</p>

<p>The stream <code>xn</code> defined above is potentially unbound, it represents all the sequence of <code>xn</code> obtained as <code>0, deltaX, deltaX + deltaX, deltaX + deltaX + deltaX, ...</code> but we can set easily an upper limit in this way</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">xnPi</span> <span class="k">=</span> <span class="n">xn</span><span class="o">.</span><span class="n">takeWhile</span><span class="o">(</span><span class="k">_</span> <span class="o">&lt;</span> <span class="nc">Math</span><span class="o">.</span><span class="nc">PI</span><span class="o">)</span>
</span><span class="line"><span class="n">xnPi</span><span class="k">:</span> <span class="kt">scala.collection.immutable.Stream</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>We can now take the values of the <code>f</code> function in each of these values simply by mapping the <code>Stream</code> of <code>xn</code> through the function:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="k">def</span> <span class="n">ynPi</span> <span class="k">=</span> <span class="n">xnPi</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">)</span>
</span><span class="line"><span class="n">ynPi</span><span class="k">:</span> <span class="kt">scala.collection.immutable.Stream</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In the context of <code>Stream</code>s we can see the map application as a transformation from the sequence of $x_n$ to the sequence of $f_n := f(x_n)$. 
This interpretation of the <code>map</code> function applies only to sequence-like types such as Streams and Lists, but it has a very different interpretation in other types, where concepts coming from Category Theory come into place, and lead to the ideas of Monoids and Monads.</p>

<p>Now the only thing left to do is add up the <code>ynPi</code> and multiply them by $\Delta x$, and this can easily be achieved through a <code>foldLeft</code> application:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="Scala"><span class="line"><span class="n">scala</span><span class="o">&gt;</span> <span class="n">deltaX</span> <span class="o">*</span> <span class="n">ynPi</span><span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="mf">0.0</span><span class="o">)(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
</span><span class="line"><span class="n">res1</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="mf">1.9999900283082575</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>So we obtained quite simply, mapping directly the theoretical concepts down to language constructs, in 5 lines of code, a value pretty close to the real one. Consider how much verbosity and focus on the implementation details it would have taken having this implemented in Java or in any case in a procedural way. With Scala and in general with a functional approach we just focus on what we want to achieve, through which transformations, instead of focusing on the processing details. In this way we produce code that is more isolated, testable, and appliable in different contexts.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/08/price-of-locks/">Parallelizing Costs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-08T10:27:37+01:00" pubdate data-updated="true"><time class='entry-date' datetime='2015-03-08T10:27:37+01:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span></time></time>
        
         | <a href="/blog/2015/03/08/price-of-locks/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4 id="why-learning-concurrency">Why learning concurrency</h4>
<p>Studying for the OCP exam offers a nice opportunity to dive into one of the most important (and sometimes overlooked) aspects of the Java language and JVM: threads and concurrency frameworks.
Before I never delved into the details about concurrency just because I have been working on a container (like Tomcat) or on a framework (like Apache Camel) that takes care of distributing load on a thread pool, and basically every request or every message processing can in 99% of cases be treated as a synchronous process, so I survived for many years without having a good understanding of how concurrency works in Java.</p>

<p>Learning how threads and concurrency works is important especially if we look at how hardware is evolving. Processors speed is not increasing any more (due to physical limitations) but processors are getting <em>large</em>, i.e. the number of cores is increasing, and we must be able to make best use of them.</p>

<h4 id="threads-in-java">Threads in Java</h4>
<p>When we talk about threads a distinction must be made between a <em>thread as object</em> and a <em>thread of execution</em>. Java has supported threads since the very beginning in a native way. As everything in Java is handled as an object, threads are not an exception, and a thread is represented by the <code>java.lang.Thread</code> class. A thread of execution instead represents a call stack that is being executed on the JVM. You can visualize multiple threads running as many call stacks running independently. However threads can possibly work on the same objects in the Heap, and there are a number of mechanisms provided within the language to allow handling in a safe way these shared objects (synchronized blocks and methods, locks, read/write locks, atomic variables).
I used to think myself that parallelizing things could lead automatically to better performance, but after diving a bit into the subject, I came across a great presentation from Martin Thompson that I really <a href="https://www.youtube.com/watch?v=4dfk3ucthN8">recommend</a>. This presentation is great for a couple of reasons, first it makes it clear that having knowledge about the general structure of the machine on  which our programs run is paramount to have efficient code. We donâ€™t need to know all the details as if we are developing firmware code for a particular processor, but a general understanding of how modern multicore CPUs work is recommended (<em>mechanical sympathy</em>). Secondly, it conveys the important concept that having threads contending a certain resource and swapping context take time, and it might be not always convenient to parallelize. So <em>parallelize with a grain of salt</em>. </p>

<h4 id="benchmark">Benchmark</h4>
<p>To convince myself of the fact that parallelization is not necessarily good,  I used the same example suggested in the <a href="http://lmax-exchange.github.io/disruptor/files/Disruptor-1.0.pdf">Disruptor presentation</a>, a very trivial problem which is incrementing an <code>int</code> variable 10.000.000 times. The aim is to compare the performance of these approaches in dealing with this problem.
Letâ€™s first outline the different approaches used, then we will go through the performance results. The code can be found <a href="https://github.com/pierangeloc/java-8-playground/tree/master/src/main/java/com/pierangeloc/java8/threads">here</a></p>

<h6 id="single-threaded-with-a-while-loop">Single threaded, with a while loop</h6>
<p>This is the most trivial approach:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">i</span><span class="o">++;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The while loop is executed on one single thread. </p>

<h6 id="single-threaded-with-a-lockunlock-within-the-loop">Single threaded, with a lock/unlock within the loop</h6>
<p>To measure the price of a simple lock and unlock, without any other thread involved in it (no actual contention), I used this second strategy:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
</span><span class="line">    <span class="n">i</span><span class="o">++;</span>
</span><span class="line">    <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h6 id="single-threaded-with-synchronized-block-within-the-loop">Single threaded, with synchronized block within the loop</h6>
<p>An equivalent approach to the previous one is to synchronize the whole block in the while loop</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">i</span><span class="o">++;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then we can start to really parallelize things and see how it goes. I tested this on an Intel i7 (8 cores) machine, using 4 threads</p>

<h6 id="threads-without-locking-nor-synchronizing-inconsistent-results">4 threads, without locking nor synchronizing (inconsistent results)</h6>
<p>We define a list of Callables that share the same integer holder, increasing it concurrently</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * MultiThreadedUnlockedStrategy.java</span>
</span><span class="line"><span class="cm">*/</span>
</span><span class="line"><span class="n">IntHolder</span> <span class="n">intHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">IntHolder</span><span class="o">();</span>
</span><span class="line"><span class="n">List</span><span class="o">&lt;</span><span class="n">IntIncrementer</span><span class="o">&gt;</span> <span class="n">incrementers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span><span class="line"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">incrementers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">IntIncrementer</span><span class="o">(</span><span class="n">intHolder</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="n">executorService</span><span class="o">.</span><span class="na">invokeAll</span><span class="o">(</span><span class="n">incrementers</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * IntIncrementer.java</span>
</span><span class="line"><span class="cm">*/</span>
</span><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="n">IntHolder</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;incrementing&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="n">holder</span><span class="o">.</span><span class="na">value</span><span class="o">++;</span>
</span><span class="line">    <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>As expected, this strategy leads to incorrect and inconsistent results, e.g. 9978258</p>

<h6 id="threads-with-lockingunlocking-in-each-incrementation">4  threads, with locking/unlocking in each incrementation</h6>
<p>The incrementation block is synchronized on the holder object</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * MultiThreadedLockedStrategy.java</span>
</span><span class="line"><span class="cm">*/</span>
</span><span class="line"><span class="n">IntHolder</span> <span class="n">intHolder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">IntHolder</span><span class="o">();</span>
</span><span class="line"><span class="n">List</span><span class="o">&lt;</span><span class="n">LockingIntIncrementer</span><span class="o">&gt;</span> <span class="n">incrementers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span><span class="line"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">incrementers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">LockingIntIncrementer</span><span class="o">(</span><span class="n">intHolder</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="n">executorService</span><span class="o">.</span><span class="na">invokeAll</span><span class="o">(</span><span class="n">incrementers</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * LockingIntIncrementer.java</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="n">IntHolder</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">holder</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;incrementing&quot;</span><span class="o">);</span>
</span><span class="line">        <span class="n">holder</span><span class="o">.</span><span class="na">value</span><span class="o">++;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="n">holder</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>This leads to consistent and correct results.</p>

<h6 id="threads-with-atomicinteger">4  threads, with AtomicInteger</h6>
<p>The incrementation block is synchronized on the holder object</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * MultiThreadedLockedStrategy.java</span>
</span><span class="line"><span class="cm">*/</span>
</span><span class="line"><span class="n">AtomicInteger</span> <span class="n">atomicInteger</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AtomicInteger</span><span class="o">();</span>
</span><span class="line"><span class="n">List</span><span class="o">&lt;</span><span class="n">AtomicIntIncrementer</span><span class="o">&gt;</span> <span class="n">incrementers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>
</span><span class="line"><span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">times</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">incrementers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="nf">AtomicIntIncrementer</span><span class="o">(</span><span class="n">atomicInteger</span><span class="o">));</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="n">executorService</span><span class="o">.</span><span class="na">invokeAll</span><span class="o">(</span><span class="n">incrementers</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * AtomicIntIncrementer.java</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">atomicInteger</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="n">Integer</span> <span class="nf">call</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class="line">    <span class="n">LOGGER</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;incrementing&quot;</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">atomicInteger</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>This strategy also leads to correct results.</p>

<h6 id="threads-with-forkjoin">4  threads, with ForkJoin</h6>
<p>The approach followed in this case has been totally different. We have constructed an array of 10.000.000 ones, and added the values through a fork/join.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * MultiThreadedLockedStrategy.java</span>
</span><span class="line"><span class="cm">*/</span>
</span><span class="line"><span class="kt">int</span><span class="o">[]</span> <span class="n">ones</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">times</span><span class="o">];</span>
</span><span class="line"><span class="n">AddingTask</span> <span class="n">mainTask</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AddingTask</span><span class="o">(</span><span class="n">ones</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">ones</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class="line"><span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">forkJoinPool</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">mainTask</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * AddingTask.java</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="nf">AddingTask</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">array</span><span class="o">,</span> <span class="kt">int</span> <span class="n">from</span><span class="o">,</span> <span class="kt">int</span> <span class="n">to</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">this</span><span class="o">.</span><span class="na">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">;</span>
</span><span class="line">        <span class="k">this</span><span class="o">.</span><span class="na">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span>
</span><span class="line">        <span class="k">this</span><span class="o">.</span><span class="na">to</span> <span class="o">=</span> <span class="n">to</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">protected</span> <span class="n">Integer</span> <span class="nf">compute</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span><span class="o">(</span><span class="n">to</span> <span class="o">-</span> <span class="n">from</span> <span class="o">&lt;=</span> <span class="n">THRESHOLD</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">return</span> <span class="n">to</span> <span class="o">-</span> <span class="n">from</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">mid</span> <span class="o">=</span> <span class="o">(</span><span class="n">to</span> <span class="o">+</span> <span class="n">from</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">;</span>
</span><span class="line">        <span class="n">AddingTask</span> <span class="n">left</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AddingTask</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">mid</span><span class="o">);</span>
</span><span class="line">        <span class="n">left</span><span class="o">.</span><span class="na">fork</span><span class="o">();</span>
</span><span class="line">        <span class="n">AddingTask</span> <span class="n">right</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AddingTask</span><span class="o">(</span><span class="n">array</span><span class="o">,</span> <span class="n">mid</span><span class="o">,</span> <span class="n">to</span><span class="o">);</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">rightComputationResult</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="na">compute</span><span class="o">();</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">leftComputationResult</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
</span><span class="line">        <span class="k">return</span> <span class="n">leftComputationResult</span> <span class="o">+</span> <span class="n">rightComputationResult</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>This strategy leads to correct results.</p>

<h4 id="performance-analysys">Performance analysys</h4>
<p>The following table sums up the results from the various strategies, and compares their performances</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="o">+------------------------------------+----------------+---------------------+</span>
</span><span class="line"><span class="o">|</span> <span class="n">Strategy</span>                           <span class="o">|</span> <span class="n">Correct</span> <span class="n">result</span> <span class="o">|</span> <span class="n">Execution</span> <span class="n">time</span> <span class="o">[</span><span class="n">ms</span><span class="o">]</span> <span class="o">|</span>
</span><span class="line"><span class="o">|------------------------------------|----------------|---------------------|</span>
</span><span class="line"><span class="o">|</span> <span class="n">Single</span> <span class="n">Threaded</span> <span class="n">Lock</span> <span class="n">Free</span>          <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">3</span>                   <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="n">Single</span> <span class="n">Threaded</span> <span class="n">with</span> <span class="n">lock</span>          <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">197</span>                 <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="n">Single</span> <span class="n">Threaded</span> <span class="n">with</span> <span class="n">syncchronized</span> <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">237</span>                 <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="mi">4</span> <span class="n">Threads</span> <span class="n">without</span> <span class="n">lock</span>             <span class="o">|</span> <span class="n">No</span>             <span class="o">|</span> <span class="mi">25710</span>               <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="mi">4</span> <span class="n">Threads</span> <span class="n">with</span> <span class="n">lock</span>                <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">10498</span>               <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="mi">4</span> <span class="n">Threads</span> <span class="n">with</span> <span class="n">AtomicInteger</span>       <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">11121</span>               <span class="o">|</span>
</span><span class="line"><span class="o">|</span> <span class="mi">4</span> <span class="n">Threads</span> <span class="n">with</span> <span class="n">Fork</span><span class="o">/</span><span class="n">Join</span>           <span class="o">|</span> <span class="n">Yes</span>            <span class="o">|</span> <span class="mi">1045</span>                <span class="o">|</span>
</span><span class="line"><span class="o">+------------------------------------+----------------+---------------------+</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The problem we tried to solve here was trivial, but from this table we can se that the easiest approach is also the most efficient.</p>

<p>We can also see that just introducing a locking mechanism in a single thread, so without any contention of the lock itself, makes the application about 70 times slower.</p>

<p>When we start working with 4 threads sharing an object, we can see that without locking the results are inconsistent, but in any case the approach is extremely inefficient. Threads must share this object so there is a continuous context switch and update between the cores on which the threads are running.</p>

<p>When we introduce the locking mechanism, results are correct and paradoxically the execution time got reduced. </p>

<p>With <code>AtomicInteger</code> I was expecting a better performance than with the locking mechanism, but actually it got worse. This proves that when there is high contention on an object, also AtomicInteger is not a panacea.</p>

<p>Among the parallelized approaches, the one that proved to work best is the Fork/Join, but in order to apply it we had to change the approach and get to adding the elements of an array.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/10/22/some-notes-about-java-certification-exam/">Some Notes About Java Certification Exam</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-10-22T21:37:45+02:00" pubdate data-updated="true"><time class='entry-date' datetime='2014-10-22T21:37:45+02:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span></time></time>
        
         | <a href="/blog/2014/10/22/some-notes-about-java-certification-exam/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>With this post I am starting my blog, and I dedicate it (like probably the next few ones) to topics I am encountering during the preparation of the Java Professional Certification exam.
Even if you probably have been using Java for many years, Java certification offers an opportunity to discover details about the language and its features.
In the following notes I am collecting a few points that I found at least not obvious, either because I never had the chance to look into them before, or because they showed some peculiar behavior worth keeping in mind. The following notes refer to Java 7.</p>

<h4 id="precise-rethrow">Precise rethrow</h4>
<p>This is a feature that has been introduced in the Java 7 compiler, and it can be expressed in this way:<br />
<em>When rethrowing an exception, the rethrown type doesnâ€™t have necessarily to be of the same type declared in the <code>catch</code> block. If e.g. the <code>try</code> block can throw exceptions of type <code>E1</code>, <code>E2</code>, <code>E3</code> all subtypes of <code>E</code> which is the type in the <code>catch</code> clause, the rethrowing action is aware of being restricted to types <code>E1</code>, <code>E2</code>, <code>E3</code> and not necessarily to <code>E</code>.</em><br />
This can be easily better explained through an example</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PreciseRethrow</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">rethrowException</span><span class="o">(</span><span class="n">String</span> <span class="n">exceptionOrdinal</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ExceptionB</span><span class="o">,</span> <span class="n">ExceptionA</span> <span class="o">{</span>
</span><span class="line">        <span class="k">try</span> <span class="o">{</span>
</span><span class="line">            <span class="k">if</span><span class="o">(</span><span class="n">exceptionOrdinal</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;first&quot;</span><span class="o">))</span>
</span><span class="line">                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionA</span><span class="o">();</span>
</span><span class="line">            <span class="k">else</span>
</span><span class="line">                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionB</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class="line">            <span class="n">Exception</span> <span class="n">f</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span><span class="line">            <span class="k">throw</span> <span class="n">f</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="o">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">class</span> <span class="nc">ExceptionA</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{}</span>
</span><span class="line"><span class="kd">class</span> <span class="nc">ExceptionB</span> <span class="kd">extends</span> <span class="n">Exception</span> <span class="o">{}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>The compiler analyzes the code in the <code>try</code> clause and detects that only <code>FirstException</code> or <code>SecondException</code> can be thrown, therefore despite the <code>catch</code> block refers to a generic <code>Exception</code> class, it is aware that the actual exception being rethrown in the <code>throw e;</code> can either be of type <code>FirstException</code> or <code>SecondException</code>, therefore the <code>rethrowException()</code> method can declare <code>throws ExceptionB, ExceptionA</code> instead of <code>throws Exception</code>.<br />
If the exception being rethrown is copied to a variable local to the <code>catch</code> block which is in turn rethrown, like in this version of the <code>catch</code> block</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="Java"><span class="line"><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class="line">            <span class="n">Exception</span> <span class="n">f</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
</span><span class="line">            <span class="k">throw</span> <span class="n">f</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>this nice behavior of the compiler ceases to occur, so it will produce a compilation error.</p>

<hr />
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/07/22/ride-the-camel-1/">Getting started with Apache Camel</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/12/scalajs-for-dynamic-systems-simulation/">Scala.js for dynamic systems simulation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/06/integrals-in-scala/">A simple Scala application: calculating integrals</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/08/price-of-locks/">Parallelizing costs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/10/22/some-notes-about-java-certification-exam/">Some notes about Java Certification exam</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/pierangeloc">@pierangeloc</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'pierangeloc',
            count: 0,
            skip_forks: true,
            target: '#gh_repos',
            blacklist: ''
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Pierangelo Cecchetto -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'pierangelosbakery';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
